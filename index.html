<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Memory challenge!</title>
<meta name="theme-color" content="#192b37">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@600;700&display=swap">
<style>
:root{ --bg:#192b37; --accent:#ff5640; --accent2:#ffa394; --panel:#0f1b23; --panel2:#122430; --good:#22c55e; --bad:#ef4444; --text:#e5e7eb; --muted:#a3aed0; --yellow:#f59e0b; --red:#ef4444; --green:#22c55e; }
*{box-sizing:border-box}
body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);
      display:flex; min-height:100dvh; align-items:center; justify-content:center; overflow-x:hidden; }
.wrap{width:min(1100px,95vw);}
/* MENU */
.menu-card{ width:min(460px,92vw); border-radius:18px; padding:16px 14px 20px;
  background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
  border:1px solid rgba(255,255,255,.08); box-shadow:0 18px 40px rgba(0,0,0,.4) }
.menu-title{ display:flex; align-items:center; gap:10px; margin:2px 6px 12px; font-size:20px; font-weight:800; letter-spacing:.4px; font-family:"Chakra Petch",system-ui,sans-serif }
.menu-title .logo{ width:36px; height:36px; border-radius:10px; background:#ff5640; display:inline-block; }
.menu-list{ display:flex; flex-direction:column; gap:10px; padding:4px }
.menu-btn{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.1);
  background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#0b1020; font-weight:800; cursor:pointer; box-shadow:0 6px 0 rgba(0,0,0,.25), 0 10px 22px rgba(0,0,0,.35); }
.menu-left{ display:flex; align-items:center; gap:10px }
.menu-icon{ width:28px; height:28px; border-radius:10px; background:#0b1020; color:var(--accent); display:grid; place-items:center; box-shadow:inset 0 0 0 1px rgba(255,255,255,.12) }
/* PANELS */
.panel{ background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%); padding:16px; border-radius:14px; border:1px solid rgba(255,255,255,.08); box-shadow:0 10px 30px rgba(0,0,0,.35) }
.controls{ display:grid; grid-template-columns: repeat(2, minmax(160px,1fr)); gap:10px; background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
  padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.35) }
.control{ display:flex; flex-direction:column; gap:6px }
.control label{ font-size:12px; color:var(--muted) }
select, button, input[type="text"]{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0f1530; color:var(--text); }
.primary{ background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#0b1020; font-weight:800; border:none; font-family:"Chakra Petch",system-ui,sans-serif }
.ghost{ background:transparent; border:1px solid rgba(255,255,255,.2); color:var(--text); border-radius:10px; padding:10px 12px }
.pill{ border-radius:9999px; padding:6px 10px; font-size:12px }
/* HUD */
.hud{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 }
.hud .lives,.hud .score,.hud .round{ display:flex; align-items:center; gap:6px; background:#0f1530; border:1px solid rgba(255,255,255,.12); border-radius:999px; padding:6px 10px; font-size:12px }
.hud .mode{ position:relative; display:flex; align-items:center; gap:6px; border-radius:999px; padding:6px 10px; font-size:12px; border:1px solid rgba(255,255,255,.12); background:#0f1530; cursor:pointer }
.mode.easy{ border-color:var(--green); color:var(--green) } .mode.medium{ border-color:var(--yellow); color:var(--yellow) } .mode.hard{ border-color:var(--red); color:var(--red) }
.mode-select{ position:absolute; top:110%; left:0; z-index:20; display:none; }
.mode.open .mode-select{ display:block; }
.actions{ margin-left:auto; display:flex; gap:6px; align-items:center }
/* BOARD */
.progress{ height:6px; background:#0a0f25; border:1px solid rgba(255,255,255,.1); border-radius:999px; overflow:hidden; margin:6px 0 2px }
.progress>span{ display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2)); transition:width .1s ease }
.grid-wrap{ display:grid; place-items:center; margin-top:8px; }
.grid{ display:grid; gap:8px; background:#0f1530; padding:10px; border-radius:16px; border:1px solid rgba(255,255,255,.08); box-shadow:0 10px 35px rgba(0,0,0,.45);
        width:min(95vw, 640px); }
.cell{ width:100%; aspect-ratio:1; border-radius:12px; background:#1a2746; border:1px solid rgba(255,255,255,.08);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.04); transition:transform .1s ease, background .12s ease, box-shadow .12s ease, filter .12s ease;
  cursor:pointer; position:relative; overflow:hidden; color:#c8d2ff; font-weight:800; font-family:"Chakra Petch",system-ui,sans-serif; font-size:clamp(12px, 2.2vw, 18px); display:grid; place-items:center }
.cell:hover{ transform:translateY(-1px) }
.cell.active{ background:color-mix(in srgb, var(--accent) 80%, #131a3b 20%); box-shadow:0 0 22px color-mix(in srgb, var(--accent) 50%, #000 50%); transform:translateY(-2px) }
.cell.correct{ outline:2px solid var(--good) }
.cell.wrong{ outline:2px solid var(--bad) }
.msg{ margin-top:10px; color:#c7d2fe; min-height:22px }
.footer{ opacity:.8; font-size:12px; margin-top:10px }
.spacer{ height:8px }
@media (max-width:750px){ .grid{ width:min(96vw, 560px); } }
/* Dialogs & effects */
dialog{ border:none; border-radius:16px; padding:0; width:min(520px,94vw); background:#0f1530; color:var(--text); box-shadow:0 20px 60px rgba(0,0,0,.6) }
.dlg{ padding:16px } .dlg h3{ margin:0 0 8px 0 } .dlg p{ margin:0 10px 12px 0; color:#a3aed0 } .dlg .row{ display:flex; gap:8px; flex-wrap:wrap }
@keyframes shake{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(8px)} 40%{transform:translateX(-8px)} 60%{transform:translateX(6px)} 80%{transform:translateX(-6px)} }
.shake{ animation:shake 420ms ease }
.toast{ position:fixed; left:50%; top:10%; transform:translateX(-50%); background:#0f1530; border:1px solid rgba(255,255,255,.15);
  padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); opacity:0; pointer-events:none; color:#e5e7eb; font-weight:700; font-family:"Chakra Petch",system-ui,sans-serif }
</style>
</head>
<body>
<div class="wrap">
  <!-- MENU -->
  <section id="menuUI" class="menu-card" style="display:block;">
    <div class="menu-title"><span class="logo"></span> <span id="titleText">Memory challenge!</span></div>
    <div class="menu-list">
      <button class="menu-btn" id="btnStart"><span class="menu-left"><span class="menu-icon">‚ñ∂</span> <span>Start</span></span><span>‚Ä∫</span></button>
      <button class="menu-btn" id="btnOptions"><span class="menu-left"><span class="menu-icon">‚öô</span> <span>Options</span></span><span>‚Ä∫</span></button>
      <button class="menu-btn" id="btnLeaderboard"><span class="menu-left"><span class="menu-icon">üèÜ</span> <span>Leaderboard</span></span><span>‚Ä∫</span></button>
      <button class="menu-btn" id="btnInstructions"><span class="menu-left"><span class="menu-icon">?</span> <span>Instructions</span></span><span>‚Ä∫</span></button>
      <button class="menu-btn" id="btnQuit"><span class="menu-left"><span class="menu-icon">‚úñ</span> <span>Quit</span></span><span>‚Ä∫</span></button>
    </div>
  </section>

  <!-- OPTIONS -->
  <section id="optionsUI" class="panel" style="display:none; width:min(820px,95vw);">
    <h2 style="margin:0 0 10px 0; font-family:'Chakra Petch',system-ui,sans-serif;">Options</h2>
    <div class="controls" style="margin-bottom:12px;">
      <div class="control"><label for="gridSize">Grid size</label>
        <select id="gridSize">
          <option value="3">Easy 3x3</option>
          <option value="4">Medium 4x4</option>
          <option value="5">Hard 5x5</option>
          <option value="6">Expert 6x6</option>
        </select>
      </div>
      <div class="control"><label for="difficulty">Sequence growth</label>
        <select id="difficulty">
          <option value="beginner">Beginner (start 2, +1)</option>
          <option value="intermediate">Intermediate (start 3, +2)</option>
          <option value="advanced">Advanced (start 4, +3)</option>
          <option value="insane">Insane (random +2 to +4)</option>
        </select>
      </div>
      <div class="control"><label for="speed">Display speed per tile</label>
        <select id="speed">
          <option value="1500">Slow 1.5s</option>
          <option value="1000">Normal 1s</option>
          <option value="700">Fast 0.7s</option>
          <option value="400">Extreme 0.4s</option>
        </select>
      </div>
      <div class="control"><label for="memorize">Memorization pause</label>
        <select id="memorize">
          <option value="3000">Easy 3s</option>
          <option value="2000">Medium 2s</option>
          <option value="1000">Hard 1s</option>
          <option value="250" selected>Ultra short 0.25s</option>
        </select>
      </div>
      <div class="control"><label for="livesMode">Lives mode</label>
        <select id="livesMode">
          <option value="3" selected>Standard 3 lives</option>
          <option value="1">Hardcore 1 life</option>
          <option value="endless">Endless (until mistake)</option>
        </select>
      </div>
      <div class="control"><label for="themeSel">Theme</label>
        <select id="themeSel">
          <option value="classic" selected>Classic</option>
          <option value="neon">Neon</option>
          <option value="sunset">Sunset</option>
          <option value="mono">Mono</option>
        </select>
      </div>
      <div class="control"><label for="langSel">Language</label>
        <select id="langSel">
          <option value="en-UK">English (UK)</option>
          <option value="ro-RO">Rom√¢nƒÉ</option>
          <option value="sr-RS">Srpski</option>
          <option value="es-ES">Espa√±ol</option>
          <option value="bg-BG">–ë—ä–ª–≥–∞—Ä—Å–∫–∏</option>
        </select>
      </div>
      <div class="control"><label>&nbsp;</label><button id="btnSaveOptions" class="primary">Save</button></div>
      <div class="control"><label>&nbsp;</label><button id="btnOptionsBack" class="ghost">Back to menu</button></div>
    </div>
    <div style="font-size:12px;opacity:.85">Selections are saved for the next game.</div>
  </section>

  <!-- LEADERBOARD -->
  <section id="leaderboardUI" class="panel" style="display:none; width:min(760px,95vw);">
    <h2 style="margin:0 0 10px 0; font-family:'Chakra Petch',system-ui,sans-serif;">Leaderboard</h2>
    <div class="hud" style="margin:0 0 8px 0;">
      <button id="clearLb" class="ghost" title="Clear all scores">Clear</button>
      <span style="flex:1"></span>
      <button id="btnLeaderboardBack" class="ghost">Back to menu</button>
    </div>
    <table style="width:100%; border-collapse:collapse;">
      <thead><tr><th style="text-align:left">#</th><th style="text-align:left">Name</th><th style="text-align:left">Score</th><th style="text-align:left">Grid</th><th style="text-align:left">Mode</th><th style="text-align:left">Date</th></tr></thead>
      <tbody id="lbBody"></tbody>
    </table>
  </section>

  <!-- INSTRUCTIONS -->
  <section id="instructionsUI" class="panel" style="display:none; width:min(640px,95vw);">
    <h2 style="margin:0 0 10px 0; font-family:'Chakra Petch',system-ui,sans-serif;">Instructions</h2>
    <p style="margin:0 0 10px 0; color:#a3aed0;">
      1) Watch the highlighted squares in order.<br/>
      2) After the pause, click the same squares in the same order.<br/>
      3) Each round increases the sequence length.<br/>
      4) A mistake costs a life, unless Endless is selected.<br/>
      <strong>Tip:</strong> On 3√ó3 you can use the numpad: 7‚Äë8‚Äë9 / 4‚Äë5‚Äë6 / 1‚Äë2‚Äë3.
    </p>
    <div><button id="btnInstructionsBack" class="ghost">Back to menu</button></div>
  </section>

  <!-- GAME -->
  <section id="gameUI" style="display:none;">
    <div class="panel" style="width:min(980px,95vw);">
      <div class="hud">
        <div class="round" id="round"><span>üîÑ</span> <strong>1</strong></div>
        <div class="score" id="score"><span>‚≠ê</span> <strong>0</strong></div>
        <div class="lives" id="lives"><span>‚ù§Ô∏è</span> <strong>3</strong></div>
        <div class="mode easy" id="modeBadge" title="Click to change difficulty">Beginner
          <select id="modeInlineSel" class="mode-select">
            <option value="beginner">Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
            <option value="insane">Insane</option>
          </select>
        </div>
        <div class="actions">
          <button id="hintBtn" class="ghost pill" title="Reveal next step">Hint</button>
          <button id="pauseBtn" class="ghost pill">Pause</button>
          <button id="restartBtn" class="ghost pill">Restart</button>
          <button id="btnGameBack" class="ghost pill">Menu</button>
        </div>
      </div>
      <div class="progress" aria-hidden="true"><span id="progressBar"></span></div>
      <section class="grid-wrap">
        <div id="grid" class="grid" role="grid" aria-label="Game grid"></div>
        <div class="msg" id="message"></div>
        <div class="footer" id="tipText">Press Start to begin. Watch the sequence, then repeat it.</div>
      </section>
      <div class="spacer"></div>
      <div class="hud"><button id="startBtn" class="primary">Start game</button></div>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<!-- Save Score -->
<dialog id="saveDialog">
  <form method="dialog" class="dlg" id="saveForm">
    <h3>Save your score</h3>
    <p>Your score: <strong id="dlgScore">0</strong></p>
    <label for="playerName">Name</label>
    <div class="row">
      <input type="text" id="playerName" name="playerName" placeholder="Type your name" required maxlength="24" />
      <button class="primary" value="save">Save</button>
      <button class="ghost" id="skipBtn" type="button">Skip</button>
    </div>
  </form>
</dialog>

<!-- Game Over -->
<dialog id="gameOverDialog">
  <form method="dialog" class="dlg">
    <h3>Game over</h3>
    <p id="statsLine">Round 0 ¬∑ Best combo 0 ¬∑ Hints used 0</p>
    <div class="row">
      <button class="primary" id="continueBtn" value="continue">Continue (‚Äë50 pts)</button>
      <button class="ghost" id="replayBtn" value="replay">Show last sequence</button>
      <button class="ghost" id="goMenuBtn" value="menu">Menu</button>
    </div>
  </form>
</dialog>

<script>
(function(){
  // safe storage
  const storage = { get(k){try{return localStorage.getItem(k)}catch{return null}}, set(k,v){try{localStorage.setItem(k,v)}catch{}} };

  // sections
  const menuUI = document.getElementById('menuUI');
  const optionsUI = document.getElementById('optionsUI');
  const leaderboardUI = document.getElementById('leaderboardUI');
  const instructionsUI = document.getElementById('instructionsUI');
  const gameUI = document.getElementById('gameUI');

  // menu buttons
  const btnStart = document.getElementById('btnStart');
  const btnOptions = document.getElementById('btnOptions');
  const btnLeaderboard = document.getElementById('btnLeaderboard');
  const btnInstructions = document.getElementById('btnInstructions');
  const btnQuit = document.getElementById('btnQuit');
  const btnOptionsBack = document.getElementById('btnOptionsBack');
  const btnLeaderboardBack = document.getElementById('btnLeaderboardBack');
  const btnInstructionsBack = document.getElementById('btnInstructionsBack');
  const btnGameBack = document.getElementById('btnGameBack');
  const btnSaveOptions = document.getElementById('btnSaveOptions');

  // game elements
  const gridEl = document.getElementById('grid');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const hintBtn = document.getElementById('hintBtn');
  const restartBtn = document.getElementById('restartBtn');
  const message = document.getElementById('message');
  const roundBadge = document.getElementById('round');
  const scoreBadge = document.getElementById('score');
  const livesBadge = document.getElementById('lives');
  const modeBadge = document.getElementById('modeBadge');
  const modeInlineSel = document.getElementById('modeInlineSel');
  const progressBar = document.getElementById('progressBar');
  const toastEl = document.getElementById('toast');

  // options
  const gridSizeSel = document.getElementById('gridSize');
  const diffSel = document.getElementById('difficulty');
  const speedSel = document.getElementById('speed');
  const memorizeSel = document.getElementById('memorize');
  const livesSel = document.getElementById('livesMode');
  const themeSel = document.getElementById('themeSel');
  const langSel = document.getElementById('langSel');

  // leaderboard
  const lbBody = document.getElementById('lbBody');
  const clearLbBtn = document.getElementById('clearLb');
  const LB_KEY='memoryChallenge.leaderboard.v1';

  // dialogs
  const saveDialog = document.getElementById('saveDialog');
  const dlgScore = document.getElementById('dlgScore');
  const playerNameInput = document.getElementById('playerName');
  const skipBtn = document.getElementById('skipBtn');
  const gameOverDialog = document.getElementById('gameOverDialog');
  const continueBtn = document.getElementById('continueBtn');
  const replayBtn = document.getElementById('replayBtn');
  const goMenuBtn = document.getElementById('goMenuBtn');
  const statsLine = document.getElementById('statsLine');

  // state
  let gridSize = 3, tileCount = 9, sequence=[], playIndex=0, acceptingInput=false, roundNum=0, score=0, lives=3, endless=false;
  let displayMs = 1000, pauseAfterMs=250, seqStart=2, isPlayingBack=false, savedThisGame=false, paused=false;
  let perfectStreak=0, hintsLeft=3, bestCombo=0, clicksThisRound=0, continued=false;
  let lastSequenceSnapshot=[];

  // helpers
  const show = el => el.style.display='block';
  const hide = el => el.style.display='none';
  const goMenu =()=>{ show(menuUI); hide(optionsUI); hide(instructionsUI); hide(leaderboardUI); hide(gameUI); };
  const toast = msg => { toastEl.textContent=msg; toastEl.style.opacity=1; setTimeout(()=>toastEl.style.opacity=0,900); };
  function vibrate(p){ try{ if(navigator.vibrate) navigator.vibrate(p); }catch{} }
  function updateHUD(){
    roundBadge.querySelector('strong').textContent = String(roundNum);
    scoreBadge.querySelector('strong').textContent = String(score);
    livesBadge.querySelector('strong').textContent = endless ? '‚àû' : String(lives);
    const map = { beginner:'easy', intermediate:'medium', advanced:'hard', insane:'hard' };
    modeBadge.className = 'mode ' + (map[diffSel.value]||'easy');
    modeBadge.childNodes[0].nodeValue = diffSel.options[diffSel.selectedIndex].text.split('(')[0].trim();
  }
  function disableGrid(d){ gridEl.querySelectorAll('.cell').forEach(c=>c.disabled=d); }
  function setProgress(pct){ progressBar.style.width = Math.max(0,Math.min(100,pct))+'%'; }

  // build grid (responsive, numbered)
  function buildGrid(n){
    gridEl.innerHTML=''; gridEl.style.gridTemplateColumns=`repeat(${n},1fr)`;
    const frag=document.createDocumentFragment();
    for(let i=0;i<n*n;i++){
      const b=document.createElement('button'); b.className='cell'; b.type='button'; b.dataset.index=String(i);
      b.textContent=String(i+1); b.addEventListener('click', onCellClick);
      frag.appendChild(b);
    }
    gridEl.appendChild(frag); tileCount=n*n;
  }

  // timing
  async function rafWait(ms){ const t=performance.now(); while(performance.now()-t<ms){ await new Promise(r=>requestAnimationFrame(r)); } }
  async function flash(index){ const cell=gridEl.querySelector(`.cell[data-index="${index}"]`); if(!cell) return; cell.classList.add('active'); await rafWait(displayMs); cell.classList.remove('active'); await rafWait(120); }

  async function playback(){
    isPlayingBack=true; message.textContent='Showing sequence'; acceptingInput=false; disableGrid(true); setProgress(0);
    for(const idx of sequence){ await flash(idx); }
    await rafWait(parseInt(memorizeSel.value,10));
    message.textContent='Your turn'; acceptingInput=true; disableGrid(false); playIndex=0; clicksThisRound=0; setProgress(0); isPlayingBack=false;
  }

  function nextIncrement(){ switch(diffSel.value){ case 'beginner':return 1; case 'intermediate':return 2; case 'advanced':return 3; case 'insane':return 2+Math.floor(Math.random()*3); default:return 1; } }
  function initDifficulty(mode){ if(mode==='beginner') seqStart=2; else if(mode==='intermediate') seqStart=3; else if(mode==='advanced') seqStart=4; else seqStart=3; }
  function resetState(){ sequence=[]; playIndex=0; acceptingInput=false; roundNum=0; score=0; isPlayingBack=false; savedThisGame=false; perfectStreak=0; bestCombo=0; clicksThisRound=0; hintsLeft=3; continued=false; setProgress(0); updateHUD(); }
  function extendSequence(len){ for(let i=0;i<len;i++) sequence.push(Math.floor(Math.random()*tileCount)); }

  async function startGame(){
    gridSize=parseInt(gridSizeSel.value,10); buildGrid(gridSize);
    displayMs=parseInt(speedSel.value,10);
    endless = (livesSel.value==='endless'); lives = endless?1:parseInt(livesSel.value,10);
    initDifficulty(diffSel.value);
    resetState(); roundNum=1; message.textContent='Starting'; extendSequence(seqStart); updateHUD(); lastSequenceSnapshot = sequence.slice(); await playback();
  }

  startBtn.addEventListener('click', ()=>{ if(isPlayingBack) return; startGame(); });
  restartBtn.addEventListener('click', ()=>{ if(isPlayingBack) return; startGame(); });
  pauseBtn.addEventListener('click', ()=>{ paused=!paused; message.textContent = paused ? 'Paused' : 'Ready'; });
  hintBtn.addEventListener('click', async ()=>{
    if(isPlayingBack || !sequence.length) return;
    const nextIdx = sequence[playIndex]; const cell = gridEl.querySelector(`.cell[data-index="${nextIdx}"]`); if(!cell) return;
    acceptingInput=false; cell.classList.add('active'); await rafWait(300); cell.classList.remove('active'); await rafWait(100); acceptingInput=true; toast('Hint used');
  });

  // inline difficulty
  modeBadge.addEventListener('click', (e)=>{ modeBadge.classList.toggle('open'); e.stopPropagation(); });
  modeInlineSel.addEventListener('change', ()=>{ diffSel.value=modeInlineSel.value; storage.set('mc.difficulty', diffSel.value); updateHUD(); modeBadge.classList.remove('open'); });
  document.addEventListener('click', ()=> modeBadge.classList.remove('open'));

  async function nextRound(){ roundNum++; const inc=nextIncrement(); extendSequence(inc); updateHUD(); await rafWait(250); lastSequenceSnapshot = sequence.slice(); await playback(); toast('Round clear!'); }
  function mark(cell,ok){ cell.classList.remove('wrong','correct'); cell.classList.add(ok?'correct':'wrong'); setTimeout(()=>cell.classList.remove('wrong','correct'),400); }
  async function handleMistake(cell){ mark(cell,false); vibrate([60,60,60]); document.querySelector('.wrap').classList.add('shake'); setTimeout(()=>document.querySelector('.wrap').classList.remove('shake'),420); acceptingInput=false; perfectStreak=0; displayMs=Math.min(1500,displayMs+100);
    if(endless){ gameOver(); return; } lives--; updateHUD(); if(lives<=0){ gameOver(); } else { message.textContent='Try again'; await rafWait(900); await playback(); } }
  async function handleCorrect(cell){ mark(cell,true); playIndex++; clicksThisRound++; bestCombo=Math.max(bestCombo,clicksThisRound); score+=10; updateHUD(); setProgress((playIndex/sequence.length)*100);
    if(playIndex===sequence.length){ perfectStreak++; if(perfectStreak>=3){ displayMs=Math.max(250,displayMs-50); perfectStreak=0; } acceptingInput=false; await rafWait(300); await nextRound(); } }
  function onCellClick(e){ if(!acceptingInput || isPlayingBack) return; const idx=parseInt(e.currentTarget.dataset.index,10); const expected=sequence[playIndex]; if(idx===expected){ handleCorrect(e.currentTarget); } else { handleMistake(e.currentTarget); } }

  // keyboard numpad for 3x3
  const NP_MAP = { '1':6,'2':7,'3':8,'4':3,'5':4,'6':5,'7':0,'8':1,'9':2 };
  document.addEventListener('keydown', (e)=>{
    if(!acceptingInput || isPlayingBack) return;
    const key=e.key;
    if(gridSize===3 && /^[1-9]$/.test(key)){ const idx=NP_MAP[key]; const cell=gridEl.querySelector(`.cell[data-index="${idx}"]`); if(cell){ cell.click(); e.preventDefault(); } }
  });

  // leaderboard
  function getLB(){ try{return JSON.parse(storage.get(LB_KEY))||[]}catch{return[]} }
  function setLB(a){ storage.set(LB_KEY, JSON.stringify(a)); }
  function upsertScore(entry){ const list=getLB(); list.push(entry); const best=new Map(); for(const e of list){ const p=best.get(e.name); if(!p||e.score>p.score) best.set(e.name,e); } const merged=Array.from(best.values()).sort((a,b)=> b.score-a.score || a.date.localeCompare(b.date)).slice(0,10); setLB(merged); renderLB(); }
  function renderLB(){ const list=getLB(); lbBody.innerHTML=''; list.forEach((e,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${e.name}</td><td>${e.score}</td><td>${e.grid}x${e.grid}</td><td>${e.mode}</td><td>${new Date(e.date).toLocaleDateString()}</td>`; lbBody.appendChild(tr); }); }
  clearLbBtn.addEventListener('click', ()=>{ if(confirm('Clear all leaderboard scores?')){ setLB([]); renderLB(); } });

  // dialogs
  const saveScore = ()=>{
    const name=(playerNameInput.value||'Player').slice(0,24);
    storage.set('memoryChallenge.playerName', name);
    upsertScore({ name, score, grid:gridSize, mode:diffSel.value, date:new Date().toISOString() });
    savedThisGame=true;
  };
  skipBtn.addEventListener('click', ()=>{ if(typeof saveDialog.close==='function') saveDialog.close('skip'); else saveDialog.removeAttribute('open'); });
  saveDialog.addEventListener('close', ()=>{ if(saveDialog.returnValue==='save') saveScore(); });

  function openGameOver(){
    const s = `Round ${roundNum} ¬∑ Best combo ${bestCombo} ¬∑ Hints used ${Math.max(0,3-hintsLeft)}`;
    statsLine.textContent=s;
    if(typeof gameOverDialog.showModal==='function') gameOverDialog.showModal(); else gameOverDialog.setAttribute('open','');
  }
  function gameOver(){ message.textContent='Game over'; acceptingInput=false; disableGrid(true); if(score>0 && !savedThisGame){ dlgScore.textContent=String(score); if(typeof saveDialog.showModal==='function') saveDialog.showModal(); else saveDialog.setAttribute('open',''); } openGameOver(); }
  continueBtn.addEventListener('click', (ev)=>{
    if(continued){ ev.preventDefault(); toast('Already continued once'); return; }
    continued=true; score=Math.max(0,score-50); lives=1; updateHUD(); gameOverDialog.close('continue'); playback();
  });
  replayBtn.addEventListener('click', (ev)=>{
    ev.preventDefault();
    if(!lastSequenceSnapshot.length) return;
    (async()=>{ isPlayingBack=true; disableGrid(true); message.textContent='Showing sequence'; for(const idx of lastSequenceSnapshot){ await flash(idx); } await rafWait(200); isPlayingBack=false; if(acceptingInput){ disableGrid(false); message.textContent='Your turn'; } })();
  });
  goMenuBtn.addEventListener('click', ()=>{ gameOverDialog.close('menu'); goMenu(); });

  // options save/load
  btnSaveOptions.addEventListener('click', ()=>{
    storage.set('mc.gridSize', gridSizeSel.value);
    storage.set('mc.difficulty', diffSel.value);
    storage.set('mc.speed', speedSel.value);
    storage.set('mc.memorize', memorizeSel.value);
    storage.set('mc.lives', livesSel.value);
    storage.set('mc.theme', themeSel.value);
    storage.set('mc.lang', langSel.value);
    toast('Saved');
  });
  function loadSaved(){
    const v=(k,f)=>storage.get(k)??f;
    gridSizeSel.value=v('mc.gridSize',gridSizeSel.value);
    diffSel.value=v('mc.difficulty',diffSel.value);
    speedSel.value=v('mc.speed',speedSel.value);
    memorizeSel.value=v('mc.memorize',memorizeSel.value);
    livesSel.value=v('mc.lives',livesSel.value);
    themeSel.value=v('mc.theme',themeSel.value);
    langSel.value=v('mc.lang','en-UK');
  }

  // nav
  btnStart.addEventListener('click', ()=>{ hide(menuUI); show(gameUI); });
  btnOptions.addEventListener('click', ()=>{ hide(menuUI); show(optionsUI); });
  btnLeaderboard.addEventListener('click', ()=>{ hide(menuUI); show(leaderboardUI); renderLB(); });
  btnInstructions.addEventListener('click', ()=>{ hide(menuUI); show(instructionsUI); });
  btnOptionsBack.addEventListener('click', goMenu);
  btnLeaderboardBack.addEventListener('click', goMenu);
  btnInstructionsBack.addEventListener('click', goMenu);
  btnGameBack.addEventListener('click', goMenu);
  btnQuit.addEventListener('click', ()=> alert('Thanks for playing!'));

  // init
  function init(){ loadSaved(); buildGrid(gridSize); renderLB(); updateHUD(); }
  init();
})();
</script>
</body>
</html>
